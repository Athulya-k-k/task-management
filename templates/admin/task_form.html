{% extends 'admin/base.html' %}

{% block title %}{{ page_title }} - Task Management System{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block page_actions %}
<a href="{% url 'manage_tasks' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-2"></i>Back to Tasks
</a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>{{ page_title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Task Title -->
                    <div class="mb-4">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="fas fa-heading me-2"></i>Task Title <span class="text-danger">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger mt-1">{{ form.title.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Enter a clear, descriptive title for the task</div>
                    </div>
                    
                    <!-- Task Description -->
                    <div class="mb-4">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            <i class="fas fa-align-left me-2"></i>Description <span class="text-danger">*</span>
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger mt-1">{{ form.description.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Provide detailed information about what needs to be accomplished</div>
                    </div>
                    
                    <!-- Assignment and Due Date -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="{{ form.assigned_to.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-2"></i>Assign To <span class="text-danger">*</span>
                            </label>
                            {{ form.assigned_to }}
                            {% if form.assigned_to.errors %}
                                <div class="text-danger mt-1">{{ form.assigned_to.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                {% if user.is_superadmin %}
                                    You can assign to any user
                                {% elif user.is_admin %}
                                    You can assign to users assigned to you
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                <i class="fas fa-calendar me-2"></i>Due Date <span class="text-danger">*</span>
                            </label>
                            {{ form.due_date }}
                            {% if form.due_date.errors %}
                                <div class="text-danger mt-1">{{ form.due_date.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">When should this task be completed?</div>
                        </div>
                    </div>
                    
                    <!-- Task Status -->
                    <div class="mb-4">
                        <label for="{{ form.status.id_for_label }}" class="form-label">
                            <i class="fas fa-flag me-2"></i>Status <span class="text-danger">*</span>
                        </label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="text-danger mt-1">{{ form.status.errors.0 }}</div>
                            {% endif %}
                        <div class="form-text">Current status of the task</div>
                    </div>
                    
                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Form Actions -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'manage_tasks' %}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{{ submit_text }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Task Management Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Task Management Tips
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-bullseye me-2"></i>Writing Good Task Titles</h6>
                        <ul class="small">
                            <li>Be specific and actionable</li>
                            <li>Start with an action verb</li>
                            <li>Keep it concise but descriptive</li>
                            <li>Example: "Update user authentication system"</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-list-ul me-2"></i>Effective Descriptions</h6>
                        <ul class="small">
                            <li>Include acceptance criteria</li>
                            <li>List required resources or tools</li>
                            <li>Mention dependencies or prerequisites</li>
                            <li>Be clear about expected deliverables</li>
                        </ul>
                    </div>
                </div>
                
                <hr class="my-3">
                
                <div class="row">
                    <div class="col-md-12">
                        <h6><i class="fas fa-traffic-light me-2"></i>Task Status Guide</h6>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="text-center">
                                <span class="badge bg-warning fs-6 mb-1">Pending</span>
                                <br><small class="text-muted">Not started yet</small>
                            </div>
                            <div class="text-center">
                                <span class="badge bg-primary fs-6 mb-1">In Progress</span>
                                <br><small class="text-muted">Currently being worked on</small>
                            </div>
                            <div class="text-center">
                                <span class="badge bg-success fs-6 mb-1">Completed</span>
                                <br><small class="text-muted">Finished with report</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set today as minimum date for due date field
    const dueDateField = document.getElementById('id_due_date');
    if (dueDateField) {
        const today = new Date().toISOString().split('T')[0];
        dueDateField.setAttribute('min', today);
        
        // If editing and due date is in the past, allow it but show warning
        const currentValue = dueDateField.value;
        if (currentValue && currentValue < today) {
            const warning = document.createElement('div');
            warning.className = 'alert alert-warning mt-2';
            warning.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>This task has a past due date.';
            dueDateField.parentNode.appendChild(warning);
        }
    }
    
    // Character counter for description
    const descriptionField = document.getElementById('id_description');
    if (descriptionField) {
        const counter = document.createElement('div');
        counter.className = 'text-muted small mt-1';
        counter.id = 'desc-counter';
        descriptionField.parentNode.appendChild(counter);
        
        function updateCounter() {
            const length = descriptionField.value.length;
            counter.textContent = `${length} characters`;
            
            if (length < 20) {
                counter.className = 'text-danger small mt-1';
            } else if (length < 50) {
                counter.className = 'text-warning small mt-1';
            } else {
                counter.className = 'text-success small mt-1';
            }
        }
        
        descriptionField.addEventListener('input', updateCounter);
        updateCounter(); // Initial count
    }
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('id_title').value.trim();
        const description = document.getElementById('id_description').value.trim();
        const assignedTo = document.getElementById('id_assigned_to').value;
        const dueDate = document.getElementById('id_due_date').value;
        
        if (!title) {
            e.preventDefault();
            alert('Please enter a task title.');
            return;
        }
        
        if (!description || description.length < 10) {
            e.preventDefault();
            alert('Please provide a detailed description (at least 10 characters).');
            return;
        }
        
        if (!assignedTo) {
            e.preventDefault();
            alert('Please assign this task to a user.');
            return;
        }
        
        if (!dueDate) {
            e.preventDefault();
            alert('Please set a due date for this task.');
            return;
        }
        
        // Check if due date is in the past for new tasks
        const today = new Date().toISOString().split('T')[0];
        if (dueDate < today && !confirm('The due date is in the past. Are you sure you want to create this task?')) {
            e.preventDefault();
            return;
        }
    });
});
</script>
{% endblock %}