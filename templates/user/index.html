<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Tasks - Task Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1200px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px 15px 0 0;
        }
        .task-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-gradient:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            color: white;
        }
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            max-width: 400px;
            margin: 100px auto;
        }
        .stats-card {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-sign-in-alt me-2"></i>Login to Your Tasks
                    </h5>
                </div>
                <div class="modal-body">
                    <div id="loginError" class="alert alert-danger d-none"></div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-gradient w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete Task Modal -->
    <div class="modal fade" id="completeTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>Complete Task
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetails"></div>
                    <form id="completeTaskForm">
                        <div class="mb-3">
                            <label for="workedHours" class="form-label">
                                <i class="fas fa-clock me-2"></i>Hours Worked <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="workedHours" step="0.5" min="0.1" required 
                                   placeholder="e.g. 8.5">
                            <div class="form-text">Enter the total hours you worked on this task</div>
                        </div>
                        <div class="mb-3">
                            <label for="completionReport" class="form-label">
                                <i class="fas fa-file-alt me-2"></i>Completion Report <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="completionReport" rows="5" required 
                                      placeholder="Describe what you accomplished, challenges faced, solutions implemented, etc."></textarea>
                            <div class="form-text">Minimum 10 characters required</div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Once marked as completed, this cannot be undone.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="submitCompletion">
                        <i class="fas fa-check me-2"></i>Complete Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="d-none">
        <div class="main-container">
            <div class="header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-tasks me-3"></i>My Tasks</h2>
                        <p class="mb-0" id="userWelcome">Welcome back!</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-light" onclick="refreshTasks()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <button class="btn btn-outline-light ms-2" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4">
                <!-- Stats Section -->
                <div class="row mb-4" id="statsSection">
                    <div class="col-md-3 mb-3">
                        <div class="stats-card">
                            <i class="fas fa-tasks fa-2x mb-2"></i>
                            <h4 id="totalTasks">0</h4>
                            <p class="mb-0">Total Tasks</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                            <i class="fas fa-clock fa-2x mb-2"></i>
                            <h4 id="pendingTasks">0</h4>
                            <p class="mb-0">Pending</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <i class="fas fa-spinner fa-2x mb-2"></i>
                            <h4 id="inProgressTasks">0</h4>
                            <p class="mb-0">In Progress</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 id="completedTasks">0</h4>
                            <p class="mb-0">Completed</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="filterAll">All Tasks</label>

                            <input type="radio" class="btn-check" name="statusFilter" id="filterPending" value="pending">
                            <label class="btn btn-outline-warning" for="filterPending">Pending</label>

                            <input type="radio" class="btn-check" name="statusFilter" id="filterProgress" value="in_progress">
                            <label class="btn btn-outline-info" for="filterProgress">In Progress</label>

                            <input type="radio" class="btn-check" name="statusFilter" id="filterCompleted" value="completed">
                            <label class="btn btn-outline-success" for="filterCompleted">Completed</label>
                        </div>
                    </div>
                </div>

                <!-- Tasks Section -->
                <div class="row" id="tasksContainer">
                    <!-- Tasks will be loaded here -->
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center p-5">
                    <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
                    <p>Loading your tasks...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center p-5 d-none">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No tasks found</h4>
                    <p class="text-muted">You don't have any tasks assigned yet.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('authToken');
        let refreshToken = localStorage.getItem('refreshToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let allTasks = [];
        let currentFilter = 'all';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken && currentUser.id) {
                showApp();
                loadTasks();
            } else {
                showLogin();
            }

            // Set up filter event listeners
            document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentFilter = this.value;
                    filterTasks();
                });
            });
        });

        function showLogin() {
            document.getElementById('app').classList.add('d-none');
            new bootstrap.Modal(document.getElementById('loginModal')).show();
        }

        function showApp() {
            document.getElementById('app').classList.remove('d-none');
            document.getElementById('userWelcome').textContent = 
                `Welcome back, ${currentUser.first_name || currentUser.username}!`;
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_BASE}/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Check if user is a regular user (not admin/superadmin)
                    if (data.user.role !== 'user') {
                        errorDiv.textContent = 'This interface is for regular users only. Please use the admin panel.';
                        errorDiv.classList.remove('d-none');
                        return;
                    }

                    // Store tokens and user data
                    authToken = data.access;
                    refreshToken = data.refresh;
                    currentUser = data.user;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    // Hide login modal and show app
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    showApp();
                    loadTasks();
                } else {
                    errorDiv.textContent = data.detail || 'Invalid username or password';
                    errorDiv.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.classList.remove('d-none');
            }
        });

        // Load tasks from API
        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/tasks/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    allTasks = await response.json();
                    updateStats();
                    displayTasks(allTasks);
                } else if (response.status === 401) {
                    // Token expired, try to refresh
                    await refreshAuthToken();
                    loadTasks();
                } else {
                    throw new Error('Failed to load tasks');
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('emptyState').classList.remove('d-none');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Refresh auth token
        async function refreshAuthToken() {
            try {
                const response = await fetch(`${API_BASE}/token/refresh/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh: refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access;
                    localStorage.setItem('authToken', authToken);
                } else {
                    throw new Error('Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                logout();
            }
        }

        // Update statistics
        function updateStats() {
            const stats = {
                total: allTasks.length,
                pending: allTasks.filter(t => t.status === 'pending').length,
                inProgress: allTasks.filter(t => t.status === 'in_progress').length,
                completed: allTasks.filter(t => t.status === 'completed').length
            };

            document.getElementById('totalTasks').textContent = stats.total;
            document.getElementById('pendingTasks').textContent = stats.pending;
            document.getElementById('inProgressTasks').textContent = stats.inProgress;
            document.getElementById('completedTasks').textContent = stats.completed;
        }

        // Display tasks
        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            const emptyState = document.getElementById('emptyState');

            if (tasks.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }

            emptyState.classList.add('d-none');
            
            container.innerHTML = tasks.map(task => `
                <div class="col-lg-6 mb-4">
                    <div class="task-card card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${task.title}</h6>
                            <span class="status-badge ${getStatusColor(task.status)}">
                                ${getStatusText(task.status)}
                            </span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">${task.description}</p>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <i class="fas fa-calendar me-1"></i>
                                    <small>Due: ${formatDate(task.due_date)}</small>
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-user me-1"></i>
                                    <small>By: ${task.created_by_name}</small>
                                </div>
                            </div>
                            ${task.status === 'completed' && task.worked_hours ? 
                                `<div class="mt-2">
                                    <span class="badge bg-info">
                                        <i class="fas fa-clock me-1"></i>${task.worked_hours} hours
                                    </span>
                                </div>` : ''
                            }
                        </div>
                        <div class="card-footer">
                            ${getTaskActions(task)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter tasks
        function filterTasks() {
            let filteredTasks = allTasks;
            
            if (currentFilter !== 'all') {
                filteredTasks = allTasks.filter(task => task.status === currentFilter);
            }
            
            displayTasks(filteredTasks);
        }

        // Get status color class
        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-warning text-dark',
                'in_progress': 'bg-primary text-white',
                'completed': 'bg-success text-white'
            };
            return colors[status] || 'bg-secondary text-white';
        }

        // Get status text
        function getStatusText(status) {
            const texts = {
                'pending': 'Pending',
                'in_progress': 'In Progress',
                'completed': 'Completed'
            };
            return texts[status] || status;
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Get task actions
        function getTaskActions(task) {
            if (task.status === 'completed') {
                return `<small class="text-muted">
                    <i class="fas fa-check-circle me-1"></i>Completed on ${formatDate(task.updated_at)}
                </small>`;
            } else {
                return `
                    <div class="d-flex gap-2">
                        ${task.status === 'pending' ? 
                            `<button class="btn btn-sm btn-outline-primary" onclick="updateTaskStatus(${task.id}, 'in_progress')">
                                <i class="fas fa-play me-1"></i>Start
                            </button>` : ''
                        }
                        <button class="btn btn-sm btn-success" onclick="openCompleteModal(${task.id})">
                            <i class="fas fa-check me-1"></i>Complete
                        </button>
                    </div>
                `;
            }
        }

        // Update task status
        async function updateTaskStatus(taskId, status) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    loadTasks(); // Reload tasks to reflect changes
                } else if (response.status === 401) {
                    await refreshAuthToken();
                    updateTaskStatus(taskId, status);
                } else {
                    alert('Failed to update task status');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task');
            }
        }

        // Open complete task modal
        function openCompleteModal(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('taskDetails').innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Task: ${task.title}</h6>
                    <p class="mb-0">${task.description}</p>
                </div>
            `;

            // Store task ID for submission
            document.getElementById('completeTaskModal').setAttribute('data-task-id', taskId);
            
            new bootstrap.Modal(document.getElementById('completeTaskModal')).show();
        }

        // Submit task completion
        document.getElementById('submitCompletion').addEventListener('click', async function() {
            const taskId = document.getElementById('completeTaskModal').getAttribute('data-task-id');
            const workedHours = document.getElementById('workedHours').value;
            const completionReport = document.getElementById('completionReport').value;

            if (!workedHours || parseFloat(workedHours) <= 0) {
                alert('Please enter valid worked hours');
                return;
            }

            if (!completionReport || completionReport.trim().length < 10) {
                alert('Please provide a completion report with at least 10 characters');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'completed',
                        worked_hours: parseFloat(workedHours),
                        completion_report: completionReport.trim()
                    })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('completeTaskModal')).hide();
                    
                    // Clear form
                    document.getElementById('workedHours').value = '';
                    document.getElementById('completionReport').value = '';
                    
                    // Reload tasks
                    loadTasks();
                    
                    alert('Task completed successfully!');
                } else if (response.status === 401) {
                    await refreshAuthToken();
                    this.click(); // Retry
                } else {
                    const error = await response.json();
                    alert('Failed to complete task: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error completing task:', error);
                alert('Error completing task');
            }
        });

        // Refresh tasks
        function refreshTasks() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').classList.add('d-none');
            loadTasks();
        }

        // Logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            refreshToken = null;
            currentUser = {};
            showLogin();
        }
    </script>
</body>
</html>